# 5.3 다중 스레드 성능 방해자

## 5.3.1 캐시와 메모리 상호 작용의 기본 단위: 캐시 라인

프로그램이 어떤 데이터에 접근하면 그 다음에는 인접한 데이터에 접근할 가능성이 높아서 데이터를 묶어서 캐시해놓는 편이 효율적입니다.

이를 "묶음" 데이터라고 부르며 다른 말로 **캐시 라인**이라고 명명합니다.

캐시 라인이라고 불리는 이유는 한 줄의 데이터가 캐시로 사용되기 때문이죠.

캐시 라인이 중요한 이유는 캐시와 메모리 상호 작용의 기본 단위가 되기 떄문이며 그 크기는 일반적으로 64바이트입니다.

## 5.2.2 첫 번째 성능 방해자: 캐시 튕김 문제

만약 C++에서 다중 스레드와 단일 스레드가 각각 변수 a의 값을 10억번 증가시킨다고 했을 때 어느 방법이 더 빠를까요?

다중 스레드를 사용한다면 5억 번씩 더하는 프로그램이 2개여서 더 빠르다고 생각할 수 있지만 실제로는 10억번의 연산을 홀로 처리하는
단일 스레드가 더 빠릅니다.

위 현상은 캐시 일관성으로 알아볼 수 있습니다.

두 개의 스레드로 연산을 진행할 경우에는 전역 변수를 같이 사용하기 때문에 캐시 튕김이 발생합니다. 왜냐하면 변수 값을 읽는 연산과 할당하는 연산이
동시에 발생하기 때문이죠. 이때 변수를 무효화하는 동작이 더해져 캐시 튕김이 발생하고 이는 다중 스레드의 성능 저하로 이어집니다.

## 5.3.3 두 번째 성능 방해자: 거짓 공유 문제

그렇다면 이번에는 전역 변수를 공유하지 않고 다중 스레드와 단일 스레드의 성능을 비교하면 어떨까요? 이때도 단일 스레드가 조금 더 빠릅니다.
위 설명에 따르면 다중 스레드의 성능 저하는 전역 변수의 사용때문이었는데 조금 의아합니다.

이는 다중 스레드에서 사용한 두 변수가 동일한 캐시 라인에 존재하기 때문입니다. 앞서 언급했듯이 캐시와 메모리는 캐시 라인 단위로 상호 작용하기 떄문에
a 변수가 저장된 캐시 라인에 b 변수도 같이 저장될 가능성이 매우 큽니다.
