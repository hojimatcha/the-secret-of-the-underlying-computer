# 2. 스레드 간 공유되는 프로세스 리소스

운영 체제가 제공하는 프로세스와 스레드라는 추상화 개념을 알아보자.

프로세스와 스레드의 차이점으로,
<br />
프로세스는 운영 체제가 리소스를 할당하는 기본 단위고,
<br />
스레드는 스케줄링의 기본 단위이며 프로세스 리소스는 스레드 간 공유된다라고 흔히 알려져 있다.

정확하게 동작하는 다중 프로세스 프로그램 작성을 위해
<br />
스레드 전용 리소스(thread-private resource)이 어떤 게 있는 지 먼저 알아보자.

<br />
<br />

## 2.1 스레드 전용 리소스

### 🧐 상태 변화 관점으로 봐본다면?

해당 관점으로 봤을 땐 **"스레드 = 함수 실행"** 이다.
<br />
함수 실행에는 항상 하나의 시작점이 존재하는데 이게 바로 진입 함수이다.
(시작점 `===` 진입 함수)

CPU는 진입 함수에서 실행을 시작하여 하나의 실행 흐름을 생성하는데,
<br />
이 실행 흐름에 인위적으로 스레드라는 이름을 붙인 것이다.

<br />

### 함수 실행에는 어떤 종류의 정보가 존재할까?

함수의 실행 시간 정보는 <u>스택 영역을 구성하는 스택 프레임에 저장</u>된다.

**스택 프레임에 저장되는 값**

- 함수의 반환값
- 다른 함수 호출할 때 전달되는 매개변수
- 함수 내에서 사용되는 지역 변수와 레지스터 정보

<br />

> CPU는 하나의 진입 함수의 명령어를 실행하여 실행 흐름인 스레드를 형성할 때 각 스레드는 자신만 사용할 수 있는 스택 영역을 가지게 된다. (스레드 별 스택 영역이 여러 개 존재)

<br />

### 스레드의 현재 실행 상태에 속하는 것은?

- PC 레지스터 (다음 실행될 명령어 주소를 저장)
- 스택 포인터 (스레드 스택 상단 위치를 저장)
- 내부 레지스터 값 (CPU가 기계 명령어를 실행할 때)

> 다른 스레드에서는 해당 레지스터 정보를 접근할 수 없다.
> 이런 모든 정보를 **"스레드 상황 정보(thread context)"** 라고 한다.

**스레드는 프로세스 주소 공간 내에서 <u>스택 영역을 제외한 나머지 영역을 모두 공유</u>한다!**

<br />
<br />

## 2.2 코드 영역: 모든 함수를 스레드에 배치하여 실행할 수 있다.

프로세스 주소 공간의 코드 영역에는 컴파일 한 후 생성된 실행 가능한 기계 명령어가 저장된다.
<br />
이런 기계 명령어는 실행 파일에 저장되어 프로그램이 시작할 때 프로세스 주소 공간에 적재된다.

<br />

### 코드 영역은 읽기 전용(read-only)이라 변경이 어렵다?!

프로그램의 올바른 실행을 위해 당연한 것으로 프로세스 내 모든 스레드가 코드 영역을 공유하지만,
<br />
읽기 전용이기에 코드 영역에 관해서는 스레드 안전 문제(thread safety issue)가 발생하지 않는 것이다.

<br />

## 2.3 데이터 영역: 모든 스레드가 데이터 영역의 변수에 접근할 수 있다.

데이터 영역은 전역 변수(프로세스 주소 공간의 데이터 영역에 저장되는 곳)가 저장되는 곳.

프로그램이 실행되는 동안 데이터 영역 내에서는 <u>전역 변수이 인스턴스는 하나만 있기 때문에<br /> 모든 스레드가 해당 전역 변수에 접근</u>할 수 있다.

<br />

## 2.4 힙 영역: 포인터가 핵심이다.

모든 스레드가 변수 주소만 안다면(포인터를 얻을 수 있다면)
포인터가 가리키는 데이터에 접근할 수 있다.

> 힙 영역은 스레드 간 공유 리소스!

<br />

## 2.5 스택 영역:공유 공간 내 전용 데이터

### 관점에 따라 스택 영역은 영역이 달라진다.

- 추상화 측면 : 스택 영역 = 스레드 전용 공간
- 실제 구현 측면 : 엄밀히 격리된 스레드 전용 공간 X

가상 메모리 시스템은 특별한 케이스를 제외하고는
<br />다른 프로세스 주소 공간에 속한 데이터에 직접 접근하지 못하도록 보장한다.

<br />

### 그럼 스레드에서는 이런 접근 보안이 가능할까?

가능하지 않다. 하나의 스레드가 다른 스레드의 스택 프레임에서
<br />
포인터를 가져올 수 있다면 다른 스택 영역을 직접 읽고 쓸 수 있기 떄문.

> 해당 상황들이 해결이 어려운 버그나 다른 스레드의 오류로 <br />함수 스택 프레임에 손상이 가는 등 디버깅에 어려움을 겪을 수 있다.

<br />

### 스레드의 느슨한 격리 작동 방식이 문제가 된다?!

스레드 여러 개가 **하나의 프로세스에 속하는 경우**
<br />
하나의 스레드는 **다른 스레드의 스택 영역**이라 하더라도 모두 **데이터를 읽고 쓸 수 있다.**

<br />
<br />

## 2.6 동적 링크 라이브러리와 파일

링크는 컴파일 후 최종적으로 실행 파일을 생성하는 핵심적인 단계인데
<br />
이 링크에는 "정적 링크", "동적 링크"가 있다.

<br />

### 정적 링크? 동적 링크?

- 정적 링크 : 모든 종속된 라이브러리가 실행 파일에 포함되는 것
- 동적 링크: 프로그램을 시작할 때(혹은 실행 중일 때) 종속된 라이브러리의 코드와 데이터를 찾아 프로세스 주소 공간에 넣는 것

> 동적 라이브러리 데이터와 코드는 스택 / 힙 중간 여유 공간에 배치된다. (`=` 공유 리소스)

<br />
<br />

## 2.7 스레드 전용 저장소(thread local storage)

### 스레드 전용 저장소에 저장되는 변수?

- 해당 영역에 저장된 변수는 모든 스레드에서 접근 가능하다.
- 다만, 변수의 인스턴스는 각각 스레드에 속한다.
- 하나의 스레드에서 변수 값을 변경해도 다른 스레드에 속하지 않는다.

<br />

### 스레드 전용 저장소를 저장하면 어떤 점이 좋을까?

스레드 전용 저장소를 저장하면 각각 스레드에서 독점적으로 변수를 사용할 수 있다.

즉, 이 변수들은 모든 스레드에서 접근할 수 있지만
<br />
해당 변수는 초기화한 후 각각의 스레드는 이 복제본을 가지게 되는데

하나의 스레드에서 변수 값을 변경하더라도 다른 스레드는
<br />
영향을 미치지 않는다는 장점이 있다.

<br />
<br />
