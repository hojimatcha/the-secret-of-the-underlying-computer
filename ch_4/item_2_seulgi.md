# 2. CPU는 유휴 상태일 때 무엇을 할까?

대부분 CPU 사용률은 7~8% 정도로 매우 낮으며 사실 대부분 컴퓨터의 CPU 사용률은 높지 않다.
물론 게임, 이미지 처리 같은 상황은 다르게 판단해야 하지만,
현재 시스템에서는 프로세스가 301개가 열려있다해도 실제로는 많은 프로세스는 기본적으로 아무런 작업도 하고 있지 않다.

실제 특정 이벤트가 발생해 자신을 깨우기를 기다리고 있고, 프로세스는 계속 대기 상태로 머물러 있다.
나머지 CPU 시간은 모두 어디로 갔을까?

<br />
<br />

## 프로세스 관리와 스케줄링

"System Idle Process" 항목이 대부분 90%가 넘는 CPU사용률을 보이며, 때로는 99% 사용률을 보인다.
이는 이 프로세스가 거의 모든 CPU 시간을 소모하고 있음을 의미한다.

우리는 프로그램이 메모리에서 실행되면 프로세스 형태로 존재하고,
프로세스가 생성되면 운영체제가 관리하고 스케줄링한다는 것을 알고 있다.

그렇다면 운영 체제는 프로세스를 어떻게 관리할까?

### 은행의 업무 공간을 비유로 프로세스 관리/스케줄링을 살펴보자!

1. 우리가 은행에 가면 줄을 서는 것처럼 프로세스도 운영 체제의 대기열로 관리된다.
2. VIP 고객이 줄 설 필요 없이 별도 공간에서 최우선적으로 업무를 처리하는 것처럼, 운영 체제도 이와 마찬가지로 프로세스에 우선순위를 할당한다. <br / >
   또 우선순위에 따라 스케줄러가 스케줄링을 할 수 있도록 상응하는 대기열에 프로세스를 넣는다.

프로세스 스케줄링은 운영 체제가 구현해야 하는 핵심 기능 중 하나다.

<br />
<br />

## 대기열 상태 확인 : 더 나은 설계

준비 완료 대기열이 비어 있다면 현재 운영 체제가 스케줄링해야 하는 프로세스가 없고, <br />
CPU가 유휴 상태에 있다는 것을 의미한다.

커널 설계자는 유휴 작업이라는 프로세스를 만들었는데 이것이 바로 앞서 살펴보았던 윈도의 "System Idle Process"이다.
시스템에 스케줄링 가능한 프로세스가 없을 때 스케줄러는 유휴 프로세스를 꺼내서 실행한다.

이 유휴 프로세스는 무슨 일을 할까?

<br />
<br />

## 모든 것은 CPU로 돌아온다

컴퓨터 시스템의 모든 것은 CPU로 구동되며, CPU야 말로 끊임없이 일하는 존재다.

CPU 설계자는 시스템에 유휴 상태가 존재할 가능성을 고려했기 때문에 하나의 기계 명령어를 설계했는데,
이 기계 명령어가 바로 정지를 의미하는 halt 명령어이다.

### halt 명령어?

이 명령어는 CPU 내부의 일부 모듈을 절전 상태로 전환하여 전력 소비를 크게 줄인다.<br />
실행을 위해 순환에 배치하고, 가급적 절전 상태를 유지하는 것이 목표이다.

프로세스 일시 중지(suspend)와 다른데 sleep 같은 함수를 호출하면 해당 함수를 호출한 프로세스만 일시 중지된다.

CPU가 halt 명령어를 실행한다는 것은 시스템 내 더 이상 실행할 준비가 완료된 프로세스가 없다는 것이다.

<br />
<br />

## 유휴 프로세스와 CPU의 저전력 상태

스케줄링 가능한 프로세스가 더 이상 존재하지 않으면 스케줄러가 유휴 프로세스를 실행한다.
순환 구조에서 계속 halt 명령어가 실행된는 것이 CPU가 하는 일이다.

<br />
<br />

## 무한 순환 탈출: 인터럽트

- 원래 컴퓨터 운영 체제는 일정 시간마다 타이머 인터럽트를 생성한다.
- CPU는 인터럽트 신호를 감지하고, 운영 체제 내부의 인터럽트 처리 프로그램을 실행한다.
- 프로세스가 실행될 준비가 되었는지 판단하고, 준비가 되었다면 중단되었던 프로세스를 계속 실행한다.
- 준비가 되어 있지 않앗다면 프로세스를 일시 중시지시코, 스케줄러는 준비 완료 상태인 다른 프로세스를 스케줄링한다.

> 프로그램에 무한 순환이 있더라도 운영 체제는 여전히 타이머 인터럽트를 통해 프로세스의 스케줄링을 제어할 수 있다.

<br />
<br />
